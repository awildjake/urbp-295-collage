<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Map Presentation</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #1a1a2e;
      --paper: #f5f0e8;
      --accent: #c8522a;
      --gold: #d4a843;
      --muted: #8a8070;
      --panel: rgba(245, 240, 232, 0.96);
    }

    body {
      font-family: 'DM Mono', monospace;
      background: var(--ink);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── MAP ── */
    #map {
      flex: 1;
      width: 100%;
      z-index: 1;
    }

    /* Vintage map tile filter */
    .leaflet-tile {
      filter: sepia(30%) saturate(80%) brightness(95%);
    }

    /* ── SLIDE PANEL ── */
    #panel {
      position: absolute;
      top: 24px;
      left: 24px;
      z-index: 1000;
      background: var(--panel);
      border: 2px solid var(--ink);
      box-shadow: 6px 6px 0 var(--ink);
      padding: 20px 24px 16px;
      max-width: 340px;
      min-width: 280px;
    }

    #panel-eyebrow {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
    }

    #panel-title {
      font-family: 'Playfair Display', serif;
      font-size: 26px;
      font-weight: 900;
      color: var(--ink);
      line-height: 1.1;
      margin-bottom: 10px;
    }

    #panel-body {
      font-size: 12px;
      line-height: 1.7;
      color: #444;
      border-top: 1px solid var(--gold);
      padding-top: 10px;
    }

    /* ── CONTROLS ── */
    #controls {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .ctrl-btn {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: var(--ink);
      color: var(--paper);
      border: 2px solid var(--paper);
      padding: 10px 22px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, transform 0.1s;
      box-shadow: 3px 3px 0 var(--paper);
    }

    .ctrl-btn:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--paper);
      transform: translate(-1px, -1px);
      box-shadow: 4px 4px 0 var(--paper);
    }

    .ctrl-btn:active:not(:disabled) {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 var(--paper);
    }

    .ctrl-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    #slide-counter {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--paper);
      letter-spacing: 0.1em;
      min-width: 48px;
      text-align: center;
      opacity: 0.7;
    }

    /* ── PROGRESS DOTS ── */
    #dots {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border: 2px solid var(--paper);
      background: transparent;
      transition: background 0.3s;
    }

    .dot.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* ── PANEL TRANSITION ── */
    #panel {
      transition: opacity 0.35s ease;
    }

    #panel.fading {
      opacity: 0;
    }

    /* ── CUSTOM MARKER ── */
    .city-marker {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── ATTRIBUTION TWEAK ── */
    .leaflet-control-attribution {
      background: rgba(26,26,46,0.7) !important;
      color: rgba(245,240,232,0.6) !important;
      font-size: 9px !important;
    }

    .leaflet-control-attribution a { color: var(--gold) !important; }

    /* ── ZOOM CONTROL ── */
    .leaflet-control-zoom a {
      background: var(--ink) !important;
      color: var(--paper) !important;
      border-color: rgba(245,240,232,0.3) !important;
      font-family: 'DM Mono', monospace !important;
    }
    .leaflet-control-zoom a:hover {
      background: var(--accent) !important;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Slide panel -->
<div id="panel">
  <div id="panel-eyebrow">Slide 01 — Overview</div>
  <div id="panel-title">North America</div>
  <div id="panel-body">A vast continent stretching from the Arctic tundra to the tropical shores of Central America. Press <strong>Advance</strong> to begin your journey.</div>
</div>

<!-- Progress dots -->
<div id="dots">
  <div class="dot active" id="dot-0"></div>
  <div class="dot" id="dot-1"></div>
  <div class="dot" id="dot-2"></div>
  <div class="dot" id="dot-3"></div>
  <div class="dot" id="dot-4"></div>
</div>

<!-- Controls -->
<div id="controls">
  <button class="ctrl-btn" id="btn-prev" disabled onclick="changeSlide(-1)">← Back</button>
  <span id="slide-counter">1 / 3</span>
  <button class="ctrl-btn" id="btn-next" onclick="changeSlide(1)">Advance →</button>
</div>

<script>
  // ── MAP INIT ──────────────────────────────────────────────────────────────
  const map = L.map('map', {
    center: [45, -100],
    zoom: 3,
    zoomControl: true,
    attributionControl: true,
  });

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
    maxZoom: 21
  }).addTo(map);

  // ── LAYERS ───────────────────────────────────────────────────────────────
  // San José marker with custom icon
  const sjIcon = L.divIcon({
    className: '',
    html: `
      <div style="
        width: 18px; height: 18px;
        background: #c8522a;
        border: 3px solid #f5f0e8;
        border-radius: 50%;
        box-shadow: 0 0 0 3px rgba(200,82,42,0.4), 0 2px 8px rgba(0,0,0,0.5);
        animation: pulse 1.8s ease-in-out infinite;
      "></div>
      <style>
        @keyframes pulse {
          0%, 100% { box-shadow: 0 0 0 3px rgba(200,82,42,0.4), 0 2px 8px rgba(0,0,0,0.5); }
          50%       { box-shadow: 0 0 0 10px rgba(200,82,42,0.0), 0 2px 8px rgba(0,0,0,0.5); }
        }
      </style>
    `,
    iconSize: [18, 18],
    iconAnchor: [9, 9],
  });

  const sjMarker = L.marker([37.3382, -121.8863], { icon: sjIcon })
    .bindPopup(`
      <div style="font-family:'DM Mono',monospace; font-size:12px; line-height:1.6; min-width:160px;">
        <strong style="font-family:'Playfair Display',serif; font-size:15px; display:block; margin-bottom:4px;">San José, CA</strong>
        <span style="color:#8a8070;">County seat of Santa Clara County<br>Pop. ~1,000,000<br>Heart of Silicon Valley</span>
      </div>
    `, { maxWidth: 220 });

  // Berryessa Flea Market polygon
  const berryessaPolygon = L.polygon([
    [37.36799529939579, -121.88038030198197],
    [37.36764489585522, -121.87996681322566],
    [37.36720344976585, -121.87909109317262],
    [37.365781425645594, -121.87670824289937],
    [37.36378124330254, -121.87425014472257],
    [37.364299878308586, -121.87353916509494],
    [37.371432522703884, -121.8758465994007],
    [37.36799529939579, -121.88038030198197],
  ], {
    color: '#c8522a',
    weight: 2,
    fillColor: '#d4a843',
    fillOpacity: 0.25,
  }).bindPopup(`
    <div style="font-family:'DM Mono',monospace; font-size:12px; line-height:1.6; min-width:160px;">
      <strong style="font-family:'Playfair Display',serif; font-size:15px; display:block; margin-bottom:4px;">Berryessa Flea Market</strong>
      <span style="color:#8a8070;">1590 Berryessa Rd, San José<br>One of the largest flea markets<br>in the United States</span>
    </div>
  `, { maxWidth: 220 });

  var imageInter = L.imageOverlay(
    'https://res.cloudinary.com/do0ehwhde/image/upload/v1771279957/Picture1_cnopt5.jpg',
    [[37.37572907, -121.88927114], [37.37307943, -121.88712537]], {
    opacity: 1,
    interactive: true
  });

  // Keep marker hidden initially
  const layers = { sjMarker, berryessaPolygon, imageInter };

  // ── SLIDES ───────────────────────────────────────────────────────────────
  const slides = [
    {
      eyebrow: 'Slide 01 — Overview',
      title: 'North America',
      body: 'A vast continent stretching from the Arctic tundra to the tropical shores of Central America. Press <strong>Advance</strong> to begin your journey.',
      view: { center: [45, -100], zoom: 3 },
      showLayers: [],
    },
    {
      eyebrow: 'Slide 02 — West Coast',
      title: 'San José, California',
      body: 'Nestled at the southern tip of San Francisco Bay, San José is the capital of Silicon Valley — a global nexus of technology and innovation.',
      view: { center: [37.3382, -121.8863], zoom: 11 },
      showLayers: [],
    },
    {
      eyebrow: 'Slide 03 — City Marker',
      title: 'Downtown San José',
      body: 'The city marker is now visible on the map. Click it to learn more. Population approaches one million, making it the largest city in Northern California.',
      view: { center: [37.3382, -121.8863], zoom: 13 },
      showLayers: ['sjMarker'],
    },
    {
      eyebrow: 'Slide 04 — Point of Interest',
      title: 'Berryessa Flea Market',
      body: 'Located in the Berryessa district of northeast San José. One of the largest open-air flea markets in the United States, operating since 1960.',
      view: { center: [37.3676, -121.8770], zoom: 15 },
      showLayers: [],
    },
    {
      eyebrow: 'Slide 05 — Site Boundary',
      title: 'Market Footprint',
      body: 'The polygon shows the full extent of the Berryessa Flea Market grounds. The site covers roughly 120 acres along Berryessa Road. Click the polygon for details.',
      view: { center: [37.3676, -121.8770], zoom: 15 },
      showLayers: ['berryessaPolygon'],
    },
    {
      eyebrow: 'Slide 06 — Back to the City',
      title: 'San José Overview',
      body: 'Zooming back out to the wider city. The flea market boundary has been hidden — only the city marker remains.',
      view: { center: [37.3676, -121.8770], zoom: 15 },
      showLayers: ['imageInter'],
      hideLayers: ['berryessaPolygon'],
    },
  ];

  let currentSlide = 0;

  // ── PRESENTATION ─────────────────────────────────────────────────────────
  function goToSlide(index) {
    const slide = slides[index];

    // Fade panel out
    const panel = document.getElementById('panel');
    panel.classList.add('fading');

    // Fly map
    map.flyTo(slide.view.center, slide.view.zoom, { duration: 1.6, easing: t => t < 0.5 ? 2*t*t : -1+(4-2*t)*t });

    // Build cumulative set of all layers introduced up to this slide
    const visibleKeys = new Set(slides.slice(0, index + 1).flatMap(s => s.showLayers));

    // Optional: explicit removals for this slide override cumulative logic
    (slide.hideLayers || []).forEach(key => visibleKeys.delete(key));

    Object.keys(layers).forEach(key => {
      if (visibleKeys.has(key)) {
        if (!map.hasLayer(layers[key])) layers[key].addTo(map);
      } else {
        if (map.hasLayer(layers[key])) map.removeLayer(layers[key]);
      }
    });

    // Update panel after short delay
    setTimeout(() => {
      document.getElementById('panel-eyebrow').textContent = slide.eyebrow;
      document.getElementById('panel-title').textContent   = slide.title;
      document.getElementById('panel-body').innerHTML      = slide.body;
      panel.classList.remove('fading');
    }, 250);

    // Update dots
    document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === index));

    // Update counter & buttons
    document.getElementById('slide-counter').textContent = `${index + 1} / ${slides.length}`;
    document.getElementById('btn-prev').disabled = index === 0;
    document.getElementById('btn-next').disabled = index === slides.length - 1;

    currentSlide = index;
  }

  function changeSlide(delta) {
    const next = currentSlide + delta;
    if (next >= 0 && next < slides.length) goToSlide(next);
  }

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') changeSlide(1);
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowUp')   changeSlide(-1);
  });

  // Init
  goToSlide(0);
</script>
</body>
</html>