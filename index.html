<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>URBP 295 Collage</title>

        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }
            
            #map {
                width: 100%;
                height: 100vh;
            }
            
            .map-title {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                background: white;
                padding: 10px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                font-size: 18px;
                font-weight: bold;
            }

            .leaflet-image-layer:hover {
                z-index: 1000 !important;
            }

            .popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                z-index: 9999;
                backdrop-filter: blur(4px);
                animation: fadeIn 0.2s ease-out;
            }

            .popup-container {
                position: fixed;
                top: 5vh;
                left: 50%;
                transform: translateX(-50%);
                background: black;
                padding: 0;
                border: 8px solid #d4d965;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                z-index: 10000;
                max-width: 800px;
                max-height: 90vh;
                overflow: visible;
                animation: slideUp 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }

            .popup-close-btn {
                position: absolute;
                top: 16px;
                right: 16px;
                border: 2px solid #d4d965;
                background: rgba(0, 0, 0, 0.8);
                color: #d4d965;
                font-size: 24px;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                cursor: pointer;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: all 0.2s ease;
                z-index: 1;
                font-weight: 300;
            }

            .popup-close-btn:hover {
                background: #d4d965;
                color: black;
            }

            .popup-image {
                width: 100%;
                max-height: 70vh;
                object-fit: contain;
                display: block;
                background: transparent;
            }

            .popup-caption {
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translate(-50%, 50%);
                max-width: 100%;
                margin: 0;
                padding: 15px 20px;
                font-size: 24px;
                line-height: 1.4;
                color: black;
                text-align: left;
                background: #d4d965;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                font-weight: 500;
                border: 8px solid black;
                box-sizing: border-box;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }

        </style>
    </head>
    <body>
        <div id="map"></div>
        
        <!-- Leaflet JavaScript -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin="">
        </script>
        <script>
            const map = L.map('map').setView([37.368567140269306, -121.87689414145946], 18);
            
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 21
            }).addTo(map);

            // Function to load and create overlays from JSON
            function loadOverlaysFromJSON(jsonUrl, map) {
                fetch(jsonUrl)
                    .then(response => response.json())
                    .then(data => {
                        data.overlays.forEach(overlayData => {
                            createImageOverlay(overlayData, map);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading overlays:', error);
                    });
            }

            // Constructor function to create individual overlay
            function createImageOverlay(overlayData, map) {
                var imageBounds = [
                    overlayData.bounds.northEast,
                    overlayData.bounds.southWest
                ];
                
                var imageOverlay = L.imageOverlay(overlayData.imageUrl, imageBounds, {
                    opacity: 1,
                    interactive: true
                }).addTo(map);
                
                imageOverlay.on('click', function() {
                    playAudioWithFade(overlayData.soundUrl);
                });
                
                return imageOverlay;
            }

            // Usage: Load all overlays
            loadOverlaysFromJSON('assets/data/overlays.json', map);

            // Reusable function to create image popup
            function createImagePopup(imageUrl, captionText) {
                // Create popup container
                var popupContainer = document.createElement('div');
                popupContainer.className = 'popup-container';
                
                // Create close button
                var closeBtn = document.createElement('button');
                closeBtn.className = 'popup-close-btn';
                closeBtn.innerHTML = 'Ã—';
                
                // Create image
                var img = document.createElement('img');
                img.className = 'popup-image';
                img.src = imageUrl;
                
                // Create caption
                var caption = document.createElement('p');
                caption.className = 'popup-caption';
                caption.textContent = captionText;

                // Adjust caption width to match image width after image loads
                img.addEventListener('load', function() {
                    // Get the actual rendered width of the image
                    var imageWidth = img.offsetWidth;
                    // Set caption width to match (subtract border width: 16px total)
                    caption.style.width = (imageWidth - 16) + 'px';
                });

                // Create overlay background
                var overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                
                // Close popup function
                function closePopup() {
                    document.body.removeChild(popupContainer);
                    document.body.removeChild(overlay);
                }
                
                closeBtn.addEventListener('click', closePopup);
                overlay.addEventListener('click', closePopup);
                
                // Assemble and add to page
                popupContainer.appendChild(closeBtn);
                popupContainer.appendChild(img);
                popupContainer.appendChild(caption);
                document.body.appendChild(overlay);
                document.body.appendChild(popupContainer);
            }

            /*
            Interactive overlay popup images go here
            */

            // Popup 1
            var imageUrlInter1 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771268371/Asset_4_drtycr.png', // Replace with your original image URL
                imageBoundsInter1 = [[37.37099065, -121.87870059], [37.37046218, -121.87834110]];

            var imageInter1 = L.imageOverlay(imageUrlInter1, imageBoundsInter1, {
                opacity: 1,
                interactive: true
            }).addTo(map);

            var imageUrlInter2 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771269312/IMG_3091_e9pwvl.jpg';

            imageInter1.on('click', function() {
                createImagePopup(
                    imageUrlInter2,
                    'North of the Berryessa Flea Market, a mixed use housing complex occupies what was once an additional parking lot for the market.'
                );
            });

            // Popup 2
            var imageUrlInter3 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771271693/Asset_2_kydax3.png', // Replace with your original image URL
                imageBoundsInter3 = [[37.36953794, -121.87663206], [37.36928326, -121.87634877]];

            var imageInter3 = L.imageOverlay(imageUrlInter3, imageBoundsInter3, {
                opacity: 1,
                interactive: true
            }).addTo(map);

            var imageUrlInter4 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771271713/IMG_3143_l12ze8.jpg';

            imageInter3.on('click', function() {
                createImagePopup(
                    imageUrlInter4,
                    "These hats feature the names of 8 Mexican states, they are adorned in the traditional \"Piteado\" style which typically consists of embroidered leather."
                );
            });

            // Popup 3
            var imageUrlInter5 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771268861/Asset_1_wjwdor.png', // Replace with your original image URL
                imageBoundsInter5 = [[37.36943227, -121.87799916], [37.36889410, -121.87743321]];

            var imageInter5 = L.imageOverlay(imageUrlInter5, imageBoundsInter5, {
                opacity: 1,
                interactive: true
            }).addTo(map);

            var imageUrlInter6 = 'https://res.cloudinary.com/do0ehwhde/image/upload/v1771272128/IMG_3155_zjguol.jpg';

            imageInter5.on('click', function() {
                createImagePopup(
                    imageUrlInter6,
                    "Traditional Mexican wares include \"cantaro\" clay pottery and different versions of the Virgin Mary."
                );
            });

            // Popup 4
            /*
            var imageUrlInter7 = '', // Replace with your hosted image URL
                imageBoundsInter7 = [[37.37092812, -121.88146591], [37.36820387, -121.87829018]];

            var imageInter7 = L.imageOverlay(imageUrlInter7, imageBoundsInter7, {
                opacity: 1,
                interactive: true
            }).addTo(map);

            var imageInter8 = ''

            imageInter7.on('click', function() {
                createImagePopup(
                    imageUrlInter8,
                    "Traditional Mexican wares include \"cantaro\" clay pottery and different versions of the Virgin Mary."
                );
            });
            */

            /*
            End of interactive overlay popup images
            */

            var style = document.createElement('style');
            style.textContent = `
                .collage-image:hover {
                    opacity: 1 !important;
                    z-index: 1000 !important;
                }
            `;
            document.head.appendChild(style);

            // Global audio management
            var currentAudio = null;
            var isFading = false;

            // Function to get current slider volume
            function getSliderVolume() {
                return document.getElementById('volumeSlider').value / 100;
            }

            // Function to play audio with fade out
            function playAudioWithFade(audioFile) {
                // Stop any currently playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // Create or reuse audio object
                if (!currentAudio || currentAudio.src !== audioFile) {
                    currentAudio = new Audio(audioFile);
                    
                    // Add fade out listener
                    currentAudio.addEventListener('timeupdate', function() {
                        var fadeOutDuration = 3;
                        var timeLeft = currentAudio.duration - currentAudio.currentTime;
                        var sliderVolume = getSliderVolume();
                        
                        if (timeLeft <= fadeOutDuration && timeLeft > 0 && !currentAudio.paused) {
                            isFading = true;
                            currentAudio.volume = sliderVolume * (timeLeft / fadeOutDuration);
                        } else if (!isFading) {
                            currentAudio.volume = sliderVolume;
                        }
                    });
                }
                
                // Reset and play
                currentAudio.currentTime = 0;
                isFading = false;
                currentAudio.volume = getSliderVolume();
                currentAudio.play();
            }

            // Create volume control
            L.Control.VolumeControl = L.Control.extend({
                onAdd: function(map) {
                    var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    
                    container.style.backgroundColor = 'white';
                    container.style.padding = '10px';
                    container.style.borderRadius = '4px';
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">ðŸ”Š</span>
                            <input type="range" min="0" max="100" value="50" 
                                style="width: 100px;" id="volumeSlider">
                            <span id="volumeValue" style="font-size: 12px; min-width: 35px;">50%</span>
                        </div>
                    `;
                    
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);
                    
                    return container;
                }
            });

            var volumeControl = new L.Control.VolumeControl({ position: 'topright' });
            volumeControl.addTo(map);

            // Connect slider to audio
            document.getElementById('volumeSlider').addEventListener('input', function(e) {
                var volume = e.target.value / 100;
                if (currentAudio && !isFading) {
                    currentAudio.volume = volume;
                }
                document.getElementById('volumeValue').textContent = e.target.value + '%';
            });

        </script>
    </body>
</html>